{% extends 'base_without_navbar.html' %}

{% load custom_tags_extra %}

{% block content %}
<div class="container">
    <h1 class="mt-3"></h1>
<!-- 	<nav aria-label="Page navigation example">
	  <ul class="pagination">
	  	{% with new_var=page_objects|get_pages_slice:page_object %}
		    {% for page in page_objects|slice:new_var %}
				{% if page.number == page_object.number%}
				    <li class="page-item active" aria-current="page">
				      <a class="page-link" href="/manga/{{manga_object.pk}}/volume/{{volume_object.number}}/chapter/{{chapter_object.number}}/page/{{page.number}}/">{{page.number}}</a></li>
				    </li>
				{% else %}
					<li class="page-item">
						<a class="page-link" href="/manga/{{manga_object.pk}}/volume/{{volume_object.number}}/chapter/{{chapter_object.number}}/page/{{page.number}}/">{{page.number}}</a>
					</li>
				{% endif %}
		    {% endfor %}
		{% endwith %}
	  </ul>
	</nav> -->
	<div class="row justify-content-md-center">
		<div class="col-5">
			<div class="dropdown">
			  <a class="btn btn-primary btn-lg dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown" aria-expanded="false">
			    Страницы
			  </a>
			  <ul class="dropdown-menu" aria-labelledby="dropdownMenuLink">
			  	<div class="overflow-auto" style="max-width: 150px; max-height: 300px;">
			  		{% for page in page_objects%}
			  		<li>
				      <a class="dropdown-item" href="#" image_url="{{page.image.url}}" position="{{forloop.counter}}" page="{{page.number}}">{{page.number}}</a></li>
				    </li>
<!-- 						{% if page.number == page_object.number%}
						    <li>
						      <a class="dropdown-item active" href="/manga/{{manga_object.pk}}/volume/{{volume_object.number}}/chapter/{{chapter_object.number}}/page/{{page.number}}/">{{page.number}}</a></li>
						    </li>
						{% else %}
							<li>
								<a class="dropdown-item" href="/manga/{{manga_object.pk}}/volume/{{volume_object.number}}/chapter/{{chapter_object.number}}/page/{{page.number}}/">{{page.number}}</a>
							</li>
						{% endif %} -->
					{% endfor %}
				</div>
			  </ul>
			</div>
		</div>
		<div class="col-5">
			<a href="{% url 'manga_detail' manga_object.pk %}" class="btn btn-primary btn-lg">{{manga_object.name}}</a>
		</div>
		<div class="col">
			<button type="button" id="pageN" class="btn btn-primary btn-lg" disabled>Страница {{page_object.number}}</button>
		</div>
	</div>

	<h1 class="mt-3"></h1>

<!-- 	<a href="/manga/{{manga_object.pk}}/volume/{{volume_object.number}}/chapter/{{chapter_object.number}}/page/{{page_object.number|add:'1'}}/">
		<img src="{{page_object.image.url}}" class="img-fluid" alt="...">
	</a> -->
	<div id="carouselExampleControls" class="carousel slide">
	  <div class="carousel-inner">
	  	<div id="images_block">
			<img src="{{page_object.image.url}}" class="img-fluid" alt="..." position="{{page_objects|get_model_index:page_object}}">
		</div>
	  </div>
	  <button class="carousel-control-prev" type="button" arg="prev">
	    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
	    <span class="visually-hidden">Previous</span>
	  </button>
	  <button class="carousel-control-next" type="button" arg="next">
	    <span class="carousel-control-next-icon" aria-hidden="true"></span>
	    <span class="visually-hidden">Next</span>
	  </button>
	</div>
</div>

<script type="text/javascript">
$(document).ready(function() {
    $("a").click(function(event) {
        var image_url = $( this ).attr("image_url");
        if (typeof image_url !== 'undefined' && image_url !== false) {
        	var images = $( ".img-fluid" ).filter(function() {
        		// return this.style.display == "block" || this.style.display == "inline"
        		return this.style.display != "none"
        	});
        	var buff = $( "#images_block" ).filter(function() {
        		return this.getAttribute("src") == image_url
        	})
        	if(images.length){
        		images[0].style.display = "none"
        	}
        	if(!buff.length){
        		$("#pageN").html($("#pageN").html().slice(0, -1) + $(this).attr("page"));
        		$( "#images_block" ).append("<img src='"+ image_url + "' class='img-fluid' alt='...' position='" + $(this).attr("position") +"' page='" + $(this).attr("page") + "'>")
        	}
        	else {
        		buff[0].css("display", "block");
        	}
        }
    });
    $("button").click(function(event) {
    	var elem = $(this);
    	var max_position = Number("{{page_objects.count}}");
    	var button_type = false;
    	if (elem.attr("arg") == "prev") {
    		button_type = -1;
    	}
    	else if(elem.attr("arg") == "next"){
    		button_type = 1;
    	};
    	if (button_type){
    		var images = $( ".img-fluid" ).filter(function() {
        		return this.style.display != "none";
        	});
        	var buff = $( "#images_block" ).filter(function() {
        		var the_position = images[0].getAttribute("position");
        		return the_position + button_type == this.getAttribute("position")
        	});
        	if(images.length) {
        		images[0].style.display = "none";
        	};
        	var current_position = false;
        	var position = Number(images[0].getAttribute("position"));
        	if(!buff.length) {
        		if(position + button_type >= max_position) {
        			current_position = max_position;
        		} 
        		else if (position + button_type <= 1){
        			current_position = 1;
        		}
        		else{
        			current_position = position + button_type;
        		};
        		if(current_position){
        			var image_url = $("a.dropdown-item").filter(function() {
        				return String(current_position) == this.getAttribute("position");
        			})
        			$("#pageN").html($("#pageN").html().slice(0, -1) + image_url[0].getAttribute("page"));
        			$( "#images_block" ).append("<img src='"+ image_url[0].getAttribute("image_url") + "' class='img-fluid' alt='...' position='" + current_position + "' page='" + image_url[0].getAttribute("page") + "'>");
        		}
        	}
        	else {
        		buff[0].css("display", "block");
        	};
        };
    })
});
</script>
{% endblock %}